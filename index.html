<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGFLOW C4 Architecture Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        #header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        #controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        #svg-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        svg:active {
            cursor: grabbing;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node rect {
            stroke-width: 2;
            rx: 8;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .node:hover rect {
            filter: drop-shadow(0 8px 12px rgba(0, 0, 0, 0.5));
            stroke-width: 3;
        }

        .node text {
            pointer-events: none;
            user-select: none;
        }

        .node .title {
            font-weight: 600;
            font-size: 14px;
        }

        .node .subtitle {
            font-size: 11px;
            opacity: 0.9;
        }

        .node .description {
            font-size: 10px;
            opacity: 0.8;
        }

        .link {
            fill: none;
            stroke-width: 2;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .link:hover {
            opacity: 1;
            stroke-width: 3;
        }

        .link-label {
            font-size: 10px;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
            opacity: 0.8;
        }

        #breadcrumb {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 30px;
            color: white;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #breadcrumb span {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        #breadcrumb span:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #breadcrumb .separator {
            margin: 0 5px;
            cursor: default;
        }

        #legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 250px;
        }

        #legend h3 {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
        }

        #search-box {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 5px;
            font-size: 14px;
            width: 200px;
        }

        #search-box::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .highlight {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            #header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            #header h1 {
                font-size: 18px;
            }

            #controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            #legend {
                font-size: 10px;
                padding: 10px;
                max-width: 150px;
            }

            #search-box {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>üèóÔ∏è RAGFLOW C4 Architecture Diagram</h1>
            <div id="controls">
                <input type="text" id="search-box" placeholder="Search nodes...">
                <button class="btn active" id="btn-container" onclick="showLevel('container')">Container</button>
                <button class="btn" id="btn-component" onclick="showLevel('component')">Component</button>
                <button class="btn" id="btn-code" onclick="showLevel('code')">Code</button>
                <button class="btn" onclick="resetView()">Reset View</button>
                <button class="btn" onclick="fitToScreen()">Fit Screen</button>
            </div>
        </div>
        <div id="svg-container">
            <svg id="diagram"></svg>
            <div id="legend">
                <h3>Legend</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4A90E2;"></div>
                    <span>Frontend/UI</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #50E3C2;"></div>
                    <span>Backend/API</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F5A623;"></div>
                    <span>Database</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #BD10E0;"></div>
                    <span>External Service</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #7ED321;"></div>
                    <span>Storage</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #E74C3C;"></div>
                    <span>Cache/Queue</span>
                </div>
            </div>
            <div id="tooltip"></div>
        </div>
        <div id="breadcrumb">
            <span onclick="showLevel('container')">Container Level</span>
        </div>
    </div>

    <script>
        // Architecture Data
        const architectureData = {
            container: {
                nodes: [
                    { id: 'user', label: 'Users', type: 'person', tech: 'Web Browser', description: 'End users accessing RAGFLOW', color: '#9B9B9B' },
                    { id: 'frontend', label: 'Web Frontend', type: 'container', tech: 'React 18.2, UMI 4.0', description: 'Interactive UI for chat, agents, knowledge base management', color: '#4A90E2', hasChildren: true },
                    { id: 'backend', label: 'Backend API Server', type: 'container', tech: 'Flask 3.0, Python', description: 'REST API for RAG operations, document processing, LLM orchestration', color: '#50E3C2', hasChildren: true },
                    { id: 'mysql', label: 'MySQL Database', type: 'database', tech: 'MySQL 8.0', description: 'Stores users, documents, conversations, configurations', color: '#F5A623' },
                    { id: 'redis', label: 'Redis Cache', type: 'cache', tech: 'Redis/Valkey 8', description: 'Session storage, caching, task queue', color: '#E74C3C' },
                    { id: 'search', label: 'Search Engine', type: 'database', tech: 'Elasticsearch/OpenSearch/Infinity', description: 'Vector search and full-text retrieval', color: '#F5A623' },
                    { id: 'storage', label: 'Object Storage', type: 'storage', tech: 'MinIO/S3/Azure Blob', description: 'Document and file storage', color: '#7ED321' },
                    { id: 'sandbox', label: 'Sandbox Executor', type: 'container', tech: 'Python/Node.js Docker', description: 'Isolated code execution for agents', color: '#50E3C2' },
                    { id: 'llm', label: 'LLM Providers', type: 'external', tech: 'OpenAI/Azure/Anthropic/30+ providers', description: 'Chat, embedding, reranking models', color: '#BD10E0' },
                ],
                links: [
                    { source: 'user', target: 'frontend', label: 'Uses', color: '#4A90E2' },
                    { source: 'frontend', target: 'backend', label: 'API Calls', color: '#50E3C2' },
                    { source: 'backend', target: 'mysql', label: 'Read/Write', color: '#F5A623' },
                    { source: 'backend', target: 'redis', label: 'Cache', color: '#E74C3C' },
                    { source: 'backend', target: 'search', label: 'Vector Search', color: '#F5A623' },
                    { source: 'backend', target: 'storage', label: 'Store/Retrieve', color: '#7ED321' },
                    { source: 'backend', target: 'sandbox', label: 'Execute Code', color: '#50E3C2' },
                    { source: 'backend', target: 'llm', label: 'LLM Calls', color: '#BD10E0' },
                ]
            },
            component: {
                nodes: [
                    // Frontend Components
                    { id: 'ui-pages', label: 'Page Components', type: 'component', tech: 'React Pages', description: 'Chat, Agent Canvas, Dataset, Search pages', color: '#4A90E2', parent: 'frontend', hasChildren: true },
                    { id: 'ui-components', label: 'Reusable Components', type: 'component', tech: 'React Components', description: 'File upload, forms, modals, widgets', color: '#4A90E2', parent: 'frontend' },
                    { id: 'ui-services', label: 'API Services', type: 'component', tech: 'Axios/React Query', description: 'API client layer for backend communication', color: '#4A90E2', parent: 'frontend' },
                    { id: 'ui-state', label: 'State Management', type: 'component', tech: 'Zustand', description: 'Global state and data flow', color: '#4A90E2', parent: 'frontend' },

                    // Backend API Components
                    { id: 'api-apps', label: 'API Applications', type: 'component', tech: 'Flask Apps', description: 'User, Dialog, KB, Document, Agent APIs', color: '#50E3C2', parent: 'backend', hasChildren: true },
                    { id: 'services', label: 'Service Layer', type: 'component', tech: 'Python Services', description: 'Business logic and orchestration', color: '#50E3C2', parent: 'backend', hasChildren: true },
                    { id: 'rag-engine', label: 'RAG Engine', type: 'component', tech: 'Python', description: 'Document parsing, chunking, embedding pipeline', color: '#50E3C2', parent: 'backend', hasChildren: true },
                    { id: 'agent-engine', label: 'Agent/Workflow Engine', type: 'component', tech: 'Python', description: 'Canvas-based agentic reasoning with tools', color: '#50E3C2', parent: 'backend', hasChildren: true },
                    { id: 'graph-rag', label: 'Graph RAG', type: 'component', tech: 'Python', description: 'Knowledge graph extraction and reasoning', color: '#50E3C2', parent: 'backend' },
                    { id: 'deep-doc', label: 'Deep Document Understanding', type: 'component', tech: 'Python', description: 'Advanced document parsing and vision', color: '#50E3C2', parent: 'backend' },
                    { id: 'agentic-reasoning', label: 'Agentic Reasoning', type: 'component', tech: 'Python', description: 'Deep research agent capabilities', color: '#50E3C2', parent: 'backend' },
                    { id: 'db-models', label: 'Database Models', type: 'component', tech: 'Peewee ORM', description: 'User, Document, File, Task, Dialog models', color: '#50E3C2', parent: 'backend', hasChildren: true },
                ],
                links: [
                    { source: 'ui-pages', target: 'ui-components', label: 'Uses', color: '#4A90E2' },
                    { source: 'ui-pages', target: 'ui-services', label: 'API Calls', color: '#4A90E2' },
                    { source: 'ui-pages', target: 'ui-state', label: 'State', color: '#4A90E2' },
                    { source: 'ui-services', target: 'api-apps', label: 'HTTP', color: '#50E3C2' },

                    { source: 'api-apps', target: 'services', label: 'Delegates', color: '#50E3C2' },
                    { source: 'services', target: 'rag-engine', label: 'RAG Pipeline', color: '#50E3C2' },
                    { source: 'services', target: 'agent-engine', label: 'Agent Exec', color: '#50E3C2' },
                    { source: 'services', target: 'graph-rag', label: 'Graph Search', color: '#50E3C2' },
                    { source: 'services', target: 'deep-doc', label: 'Parse Docs', color: '#50E3C2' },
                    { source: 'services', target: 'agentic-reasoning', label: 'Research', color: '#50E3C2' },
                    { source: 'services', target: 'db-models', label: 'CRUD', color: '#50E3C2' },

                    { source: 'rag-engine', target: 'llm', label: 'Embeddings', color: '#BD10E0' },
                    { source: 'agent-engine', target: 'llm', label: 'LLM Calls', color: '#BD10E0' },
                    { source: 'agent-engine', target: 'sandbox', label: 'Code Exec', color: '#50E3C2' },
                    { source: 'rag-engine', target: 'search', label: 'Index', color: '#F5A623' },
                    { source: 'db-models', target: 'mysql', label: 'SQL', color: '#F5A623' },
                    { source: 'services', target: 'redis', label: 'Cache', color: '#E74C3C' },
                ]
            },
            code: {
                nodes: [
                    // Frontend Code
                    { id: 'page-chat', label: 'Chat Page', type: 'code', tech: 'pages/chat/', description: 'Conversation interface with RAG', color: '#4A90E2', parent: 'ui-pages' },
                    { id: 'page-agent', label: 'Agent Canvas Page', type: 'code', tech: 'pages/agent/', description: 'Visual workflow builder', color: '#4A90E2', parent: 'ui-pages' },
                    { id: 'page-dataset', label: 'Dataset Page', type: 'code', tech: 'pages/dataset/', description: 'Knowledge base management', color: '#4A90E2', parent: 'ui-pages' },
                    { id: 'page-flow', label: 'Flow Page', type: 'code', tech: 'pages/flow/', description: 'Data flow workflows', color: '#4A90E2', parent: 'ui-pages' },

                    // Backend API Apps
                    { id: 'app-user', label: 'user_app.py', type: 'code', tech: 'User Auth API', description: 'Login, registration, profile management', color: '#50E3C2', parent: 'api-apps' },
                    { id: 'app-dialog', label: 'dialog_app.py', type: 'code', tech: 'Chat API', description: 'Conversation and message endpoints', color: '#50E3C2', parent: 'api-apps' },
                    { id: 'app-kb', label: 'kb_app.py', type: 'code', tech: 'Knowledge Base API', description: 'KB CRUD operations', color: '#50E3C2', parent: 'api-apps' },
                    { id: 'app-document', label: 'document_app.py', type: 'code', tech: 'Document API', description: 'Document upload and processing', color: '#50E3C2', parent: 'api-apps' },
                    { id: 'app-canvas', label: 'canvas_app.py', type: 'code', tech: 'Agent Canvas API', description: 'Agent workflow operations', color: '#50E3C2', parent: 'api-apps' },

                    // Service Layer
                    { id: 'svc-dialog', label: 'DialogService', type: 'code', tech: 'dialog_service.py', description: 'Chat orchestration and RAG logic', color: '#50E3C2', parent: 'services' },
                    { id: 'svc-document', label: 'DocumentService', type: 'code', tech: 'document_service.py', description: 'Document lifecycle management', color: '#50E3C2', parent: 'services' },
                    { id: 'svc-kb', label: 'KnowledgebaseService', type: 'code', tech: 'knowledgebase_service.py', description: 'KB operations', color: '#50E3C2', parent: 'services' },
                    { id: 'svc-llm', label: 'LLMService', type: 'code', tech: 'llm_service.py', description: 'LLM wrapper and streaming', color: '#50E3C2', parent: 'services' },
                    { id: 'svc-canvas', label: 'CanvasService', type: 'code', tech: 'canvas_service.py', description: 'Agent workflow execution', color: '#50E3C2', parent: 'services' },

                    // RAG Engine
                    { id: 'rag-parser', label: 'Document Parsers', type: 'code', tech: 'rag/app/', description: 'naive, qa, paper, table, book parsers', color: '#50E3C2', parent: 'rag-engine' },
                    { id: 'rag-pipeline', label: 'RAG Pipeline', type: 'code', tech: 'rag/flow/pipeline.py', description: 'Chunking, tokenization, embedding flow', color: '#50E3C2', parent: 'rag-engine' },
                    { id: 'rag-llm', label: 'LLM Models', type: 'code', tech: 'rag/llm/chat_model.py', description: '30+ LLM provider implementations', color: '#50E3C2', parent: 'rag-engine' },
                    { id: 'rag-embedding', label: 'Embedding Models', type: 'code', tech: 'rag/llm/embedding_model.py', description: 'Text embedding implementations', color: '#50E3C2', parent: 'rag-engine' },
                    { id: 'rag-rerank', label: 'Rerank Models', type: 'code', tech: 'rag/llm/rerank_model.py', description: 'Result re-ranking models', color: '#50E3C2', parent: 'rag-engine' },

                    // Agent Engine
                    { id: 'agent-canvas', label: 'Canvas', type: 'code', tech: 'agent/canvas.py', description: 'Visual workflow execution engine', color: '#50E3C2', parent: 'agent-engine' },
                    { id: 'agent-components', label: 'Components', type: 'code', tech: 'agent/component/', description: 'LLM, Tool, Switch, Iteration components', color: '#50E3C2', parent: 'agent-engine' },
                    { id: 'agent-tools', label: 'Agent Tools', type: 'code', tech: 'agent/tools/', description: 'Retrieval, code exec, web search, SQL tools', color: '#50E3C2', parent: 'agent-engine' },

                    // Database Models
                    { id: 'model-user', label: 'User', type: 'code', tech: 'db_models.py', description: 'User authentication and profiles', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-tenant', label: 'Tenant', type: 'code', tech: 'db_models.py', description: 'Multi-tenancy support', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-kb', label: 'Knowledgebase', type: 'code', tech: 'db_models.py', description: 'Knowledge base metadata', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-document', label: 'Document', type: 'code', tech: 'db_models.py', description: 'Document records and processing status', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-file', label: 'File', type: 'code', tech: 'db_models.py', description: 'File storage references', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-dialog', label: 'Dialog', type: 'code', tech: 'db_models.py', description: 'Chat conversations', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-conversation', label: 'Conversation', type: 'code', tech: 'db_models.py', description: 'Individual messages', color: '#50E3C2', parent: 'db-models' },
                    { id: 'model-task', label: 'Task', type: 'code', tech: 'db_models.py', description: 'Async task queue', color: '#50E3C2', parent: 'db-models' },
                ],
                links: [
                    { source: 'page-chat', target: 'app-dialog', label: 'API', color: '#50E3C2' },
                    { source: 'page-agent', target: 'app-canvas', label: 'API', color: '#50E3C2' },
                    { source: 'page-dataset', target: 'app-kb', label: 'API', color: '#50E3C2' },

                    { source: 'app-user', target: 'svc-dialog', label: 'Service', color: '#50E3C2' },
                    { source: 'app-dialog', target: 'svc-dialog', label: 'Service', color: '#50E3C2' },
                    { source: 'app-kb', target: 'svc-kb', label: 'Service', color: '#50E3C2' },
                    { source: 'app-document', target: 'svc-document', label: 'Service', color: '#50E3C2' },
                    { source: 'app-canvas', target: 'svc-canvas', label: 'Service', color: '#50E3C2' },

                    { source: 'svc-dialog', target: 'rag-pipeline', label: 'RAG', color: '#50E3C2' },
                    { source: 'svc-canvas', target: 'agent-canvas', label: 'Execute', color: '#50E3C2' },
                    { source: 'svc-document', target: 'rag-parser', label: 'Parse', color: '#50E3C2' },

                    { source: 'rag-pipeline', target: 'rag-embedding', label: 'Embed', color: '#50E3C2' },
                    { source: 'rag-pipeline', target: 'rag-rerank', label: 'Rerank', color: '#50E3C2' },
                    { source: 'svc-dialog', target: 'rag-llm', label: 'LLM', color: '#50E3C2' },

                    { source: 'agent-canvas', target: 'agent-components', label: 'Uses', color: '#50E3C2' },
                    { source: 'agent-components', target: 'agent-tools', label: 'Executes', color: '#50E3C2' },

                    { source: 'svc-dialog', target: 'model-dialog', label: 'CRUD', color: '#50E3C2' },
                    { source: 'svc-dialog', target: 'model-conversation', label: 'CRUD', color: '#50E3C2' },
                    { source: 'svc-kb', target: 'model-kb', label: 'CRUD', color: '#50E3C2' },
                    { source: 'svc-document', target: 'model-document', label: 'CRUD', color: '#50E3C2' },
                    { source: 'svc-document', target: 'model-file', label: 'CRUD', color: '#50E3C2' },
                ]
            }
        };

        // D3 Setup
        const svg = d3.select('#diagram');
        const container = svg.append('g');
        let currentLevel = 'container';
        let currentData = architectureData.container;
        let transform = d3.zoomIdentity;

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                transform = event.transform;
                container.attr('transform', transform);
            });

        svg.call(zoom);

        // Tooltip
        const tooltip = d3.select('#tooltip');

        // Force simulation
        let simulation;

        function initSimulation(nodes, links) {
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;

            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(200))
                .force('charge', d3.forceManyBody().strength(-1000))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(100));
        }

        function renderDiagram() {
            // Clear existing
            container.selectAll('*').remove();

            const nodes = currentData.nodes.map(d => ({ ...d }));
            const links = currentData.links.map(d => ({ ...d }));

            initSimulation(nodes, links);

            // Render links
            const link = container.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('stroke', d => d.color)
                .attr('marker-end', 'url(#arrowhead)');

            // Arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', 'white')
                .attr('opacity', 0.6);

            // Link labels
            const linkLabel = container.append('g')
                .selectAll('text')
                .data(links)
                .join('text')
                .attr('class', 'link-label')
                .text(d => d.label);

            // Render nodes
            const node = container.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', 'node')
                .call(drag(simulation))
                .on('click', (event, d) => {
                    if (d.hasChildren && currentLevel !== 'code') {
                        drillDown(d);
                    }
                })
                .on('mouseover', (event, d) => {
                    tooltip.style('opacity', 1)
                        .html(`<strong>${d.label}</strong><br/>${d.tech}<br/><em>${d.description}</em>`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', () => {
                    tooltip.style('opacity', 0);
                });

            // Node rectangles
            node.append('rect')
                .attr('width', 180)
                .attr('height', 100)
                .attr('fill', d => d.color)
                .attr('stroke', d => d3.rgb(d.color).darker(1))
                .attr('x', -90)
                .attr('y', -50);

            // Node title
            node.append('text')
                .attr('class', 'title')
                .attr('y', -20)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .text(d => d.label);

            // Node tech
            node.append('text')
                .attr('class', 'subtitle')
                .attr('y', 0)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .text(d => d.tech)
                .call(wrap, 160);

            // Node description
            node.append('text')
                .attr('class', 'description')
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .text(d => truncate(d.description, 40))
                .call(wrap, 160);

            // Drill-down indicator
            node.filter(d => d.hasChildren)
                .append('text')
                .attr('y', 45)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .text('üîç Click to explore');

            // Simulation tick
            simulation.on('tick', () => {
                link.attr('d', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dr = Math.sqrt(dx * dx + dy * dy);
                    return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                });

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        function wrap(text, width) {
            text.each(function() {
                const text = d3.select(this);
                const words = text.text().split(/\s+/).reverse();
                let word;
                let line = [];
                let lineNumber = 0;
                const lineHeight = 1.1;
                const y = text.attr('y');
                const dy = 0;
                let tspan = text.text(null).append('tspan').attr('x', 0).attr('y', y).attr('dy', dy + 'em');

                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(' '));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(' '));
                        line = [word];
                        tspan = text.append('tspan').attr('x', 0).attr('y', y).attr('dy', ++lineNumber * lineHeight + dy + 'em').text(word);
                    }
                }
            });
        }

        function truncate(str, maxLen) {
            return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
        }

        function showLevel(level) {
            currentLevel = level;
            currentData = architectureData[level];

            // Update button states
            document.querySelectorAll('#controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('btn-' + level).classList.add('active');

            // Update breadcrumb
            updateBreadcrumb(level);

            renderDiagram();
        }

        function drillDown(node) {
            if (currentLevel === 'container') {
                showLevel('component');
            } else if (currentLevel === 'component') {
                showLevel('code');
            }
        }

        function updateBreadcrumb(level) {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<span onclick="showLevel(\'container\')">Container Level</span>';

            if (level === 'component' || level === 'code') {
                html += '<span class="separator">‚Üí</span><span onclick="showLevel(\'component\')">Component Level</span>';
            }

            if (level === 'code') {
                html += '<span class="separator">‚Üí</span><span>Code Level</span>';
            }

            breadcrumb.innerHTML = html;
        }

        function resetView() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
        }

        function fitToScreen() {
            const bounds = container.node().getBBox();
            const parent = svg.node().getBoundingClientRect();
            const fullWidth = bounds.width;
            const fullHeight = bounds.height;
            const width = parent.width;
            const height = parent.height;
            const midX = bounds.x + fullWidth / 2;
            const midY = bounds.y + fullHeight / 2;

            const scale = 0.8 / Math.max(fullWidth / width, fullHeight / height);
            const translate = [width / 2 - scale * midX, height / 2 - scale * midY];

            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        // Search functionality
        document.getElementById('search-box').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();

            container.selectAll('.node').classed('highlight', false);

            if (searchTerm) {
                container.selectAll('.node')
                    .filter(d => d.label.toLowerCase().includes(searchTerm) ||
                                 d.description.toLowerCase().includes(searchTerm) ||
                                 d.tech.toLowerCase().includes(searchTerm))
                    .classed('highlight', true);
            }
        });

        // Responsive handling
        window.addEventListener('resize', () => {
            renderDiagram();
        });

        // Initial render
        renderDiagram();

        // Auto fit after initial layout
        setTimeout(fitToScreen, 2000);
    </script>
</body>
</html>
